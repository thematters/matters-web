import { ReactNode, useState } from 'react';
import {
  AutoSizer,
  CellMeasurer,
  CellMeasurerCache,
  Index,
  IndexRange,
  InfiniteLoader,
  List,
  ListRowProps,
} from 'react-virtualized';

export interface RowRendererProps<T> {
  datum: T;
  index: number;
}

interface Props<T> {
  data: T[];
  loader: ReactNode;
  loadMore: (callback: () => void) => Promise<any>;
  renderer: (props: RowRendererProps<T>) => ReactNode;
  totalCount: number;

  defaultListHeight?: number;
  defaultListMaxHeight?: number;
  defaultRowHeight?: number;
  threshold?: number;
}

export const InfiniteList = <T extends object>({
  data,
  loader,
  loadMore,
  renderer,
  totalCount,

  defaultListHeight = 10,
  defaultListMaxHeight,
  defaultRowHeight,
  threshold = 1,
}: Props<T>) => {
  const cache: CellMeasurerCache = new CellMeasurerCache({
    fixedWidth: true,
    defaultHeight: defaultListHeight,
  });

  const [listHeight, setListHeight] = useState(
    defaultRowHeight ? defaultRowHeight * data.length : defaultListHeight
  );

  const [maxHeight] = useState(
    defaultListMaxHeight || window?.innerHeight || defaultListHeight
  );

  const isRowLoaded = ({ index }: Index) => !!data[index];

  const loadMoreRows = ({ startIndex }: IndexRange) =>
    loadMore(() => cache.clear(startIndex, 0));

  const rowRenderer = ({ index, key, parent, style }: ListRowProps) => {
    const datum = data[index];
    const props = { cache, columnIndex: 0, key, parent, rowIndex: index };
    return (
      <CellMeasurer {...props}>
        <div style={style}>{datum ? renderer({ index, datum }) : loader}</div>
      </CellMeasurer>
    );
  };

  const calculate = () =>
    [...Array(data.length).keys()].reduce(
      (sum, index) => sum + cache.getHeight(index, 0),
      0
    );

  const onRowsHaveRendered = () => {
    if (listHeight < maxHeight) {
      const current = calculate();
      if (listHeight < current) {
        setListHeight(Math.min(maxHeight, current));
      }
    }
  };

  const count = data?.length || 0;

  const rowCount = (totalCount || 0) > count ? count + 1 : count;

  const listStyle = { height: `${Math.min(maxHeight, listHeight)}px` };

  return (
    <div className="infinite-list" style={listStyle}>
      <InfiniteLoader
        isRowLoaded={isRowLoaded}
        loadMoreRows={loadMoreRows}
        rowCount={totalCount}
        threshold={threshold}
      >
        {({ onRowsRendered, registerChild }) => (
          <AutoSizer>
            {({ width, height }) => (
              <List
                width={width}
                height={height}
                deferredMeasurementCache={cache}
                ref={registerChild}
                rowHeight={cache.rowHeight}
                rowRenderer={rowRenderer}
                rowCount={rowCount}
                onRowsRendered={(params) => {
                  onRowsRendered(params);
                  onRowsHaveRendered();
                }}
                overscanRowCount={0}
              />
            )}
          </AutoSizer>
        )}
      </InfiniteLoader>
    </div>
  );
};
