"use strict";(self.webpackChunkmatters_web=self.webpackChunkmatters_web||[]).push([[2481],{"./src/common/utils/form/error.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{E:()=>parseFormSubmitErrors});var _common_enums__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/common/enums/errorCode.ts"),_components_GQL__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/components/GQL/error.tsx"),parseFormSubmitErrors=function parseFormSubmitErrors(error){var codes=(0,_components_GQL__WEBPACK_IMPORTED_MODULE_0__.UX)(error),messages={};return codes.forEach((function(code){messages[code]=_common_enums__WEBPACK_IMPORTED_MODULE_1__.R[code]})),[messages,codes]}},"./src/components/Dialogs/SetEmailDialog/Confirm.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:()=>SetEmailDialog_Confirm});var asyncToGenerator=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),slicedToArray=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/slicedToArray.js"),taggedTemplateLiteral=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js"),regenerator=__webpack_require__("./node_modules/@babel/runtime/regenerator/index.js"),regenerator_default=__webpack_require__.n(regenerator),formik_esm=__webpack_require__("./node_modules/formik/dist/formik.esm.js"),lib=__webpack_require__("./node_modules/graphql-tag/lib/index.js"),pickBy=__webpack_require__("./node_modules/lodash/pickBy.js"),pickBy_default=__webpack_require__.n(pickBy),react=__webpack_require__("./node_modules/react/index.js"),useIntl=__webpack_require__("./node_modules/react-intl/lib/src/components/useIntl.js"),message=__webpack_require__("./node_modules/react-intl/lib/src/components/message.js"),events=__webpack_require__("./src/common/enums/events.ts"),errorCode=__webpack_require__("./src/common/enums/errorCode.ts"),keyValue=__webpack_require__("./src/common/enums/keyValue.ts"),enums=__webpack_require__("./src/common/enums/index.ts"),form_validate=__webpack_require__("./src/common/utils/form/validate.ts"),defineProperty=(__webpack_require__("./node_modules/lodash/get.js"),__webpack_require__("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"));function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){(0,defineProperty.Z)(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var oauth_CALLBACK_PROVIDERS=_objectSpread(_objectSpread({},{Google:"google",Facebook:"facebook",Twitter:"twitter"}),{EmailVerification:"email-verification",EmailSignup:"email-signup",EmailSignin:"email-signin"}),route=__webpack_require__("./src/common/enums/route.ts"),process=__webpack_require__("./node_modules/process/browser.js");var _templateObject,emailVerifyCallbackUrl=function emailVerifyCallbackUrl(email){var redirectPath="/callback/".concat(oauth_CALLBACK_PROVIDERS.EmailVerification),host="https://".concat(process.env.NEXT_PUBLIC_SITE_DOMAIN);return"".concat(host).concat(redirectPath,"?email=").concat(encodeURIComponent(email),"&target=").concat(encodeURIComponent(host)).concat(encodeURIComponent(route.y.ME_SETTINGS))},error=__webpack_require__("./src/common/utils/form/error.ts"),Viewer=__webpack_require__("./src/components/Context/Viewer/index.tsx"),hooks=__webpack_require__("./src/components/GQL/hooks.ts"),Form=__webpack_require__("./src/components/Form/index.tsx"),Dialog=__webpack_require__("./src/components/Dialog/index.tsx"),mutations_sendCode=__webpack_require__("./src/components/GQL/mutations/sendCode.ts"),graphql=__webpack_require__("./src/gql/graphql.ts"),__jsx=react.createElement,SET_EMAIL=(0,lib.ZP)(_templateObject||(_templateObject=(0,taggedTemplateLiteral.Z)(["\n  mutation SetEmail($input: SetEmailInput!) {\n    setEmail(input: $input) {\n      id\n      info {\n        email\n        emailVerified\n      }\n      status {\n        changeEmailTimesLeft\n      }\n    }\n  }\n"])));const SetEmailDialog_Confirm=function SetEmailDialogContent(_ref){var _viewer$status,_viewer$status2,_onSubmit,closeDialog=_ref.closeDialog,viewer=(0,react.useContext)(Viewer.Zd),intl=(0,useIntl.Z)(),presetEmail=viewer.info.email,hasPassword=!(null===(_viewer$status=viewer.status)||void 0===_viewer$status||!_viewer$status.hasEmailLoginPassword),editable=(null===(_viewer$status2=viewer.status)||void 0===_viewer$status2?void 0:_viewer$status2.changeEmailTimesLeft)>0,_useMutation=(0,hooks.Db)(SET_EMAIL,void 0,{showToast:!1}),set=(0,slicedToArray.Z)(_useMutation,1)[0],_useMutation3=(0,hooks.Db)(mutations_sendCode.Z,void 0,{showToast:!1}),sendCode=(0,slicedToArray.Z)(_useMutation3,1)[0],_useFormik=(0,formik_esm.useFormik)({initialValues:{email:presetEmail},validateOnBlur:!1,validateOnChange:!1,validate:function validate(_ref2){var email=_ref2.email;return pickBy_default()({email:(0,form_validate.oH)(email,intl,{allowPlusSign:!0})})},onSubmit:(_onSubmit=(0,asyncToGenerator.Z)(regenerator_default().mark((function _callee(_ref3,_ref4){var email,setSubmitting,setFieldError,redirectUrl,_parseFormSubmitError,_parseFormSubmitError2,messages;return regenerator_default().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return email=_ref3.email,setSubmitting=_ref4.setSubmitting,setFieldError=_ref4.setFieldError,_context.prev=2,_context.next=5,set({variables:{input:{email}}});case 5:return redirectUrl=emailVerifyCallbackUrl(email),_context.next=8,sendCode({variables:{input:{email:values.email,type:graphql.zv.EmailVerify,redirectUrl}}});case 8:window.dispatchEvent(new CustomEvent(events.jq)),setSubmitting(!1),closeDialog(),_context.next=18;break;case 13:_context.prev=13,_context.t0=_context.catch(2),_parseFormSubmitError=(0,error.E)(_context.t0),_parseFormSubmitError2=(0,slicedToArray.Z)(_parseFormSubmitError,2),messages=_parseFormSubmitError2[0],_parseFormSubmitError2[1].forEach((function(code){code.includes(errorCode.O.FORBIDDEN_BY_STATE)?setFieldError("email",intl.formatMessage({defaultMessage:"Unavailable",id:"rADhX5",description:"FORBIDDEN_BY_STATE"})):setFieldError("email",intl.formatMessage(messages[code]))})),setSubmitting(!1);case 18:case"end":return _context.stop()}}),_callee,null,[[2,13]])}))),function onSubmit(_x,_x2){return _onSubmit.apply(this,arguments)})}),values=_useFormik.values,errors=_useFormik.errors,touched=_useFormik.touched,handleChange=_useFormik.handleChange,handleSubmit=_useFormik.handleSubmit,isSubmitting=_useFormik.isSubmitting,InnerForm=__jsx(Form.l,{id:"edit-email-form",onSubmit:handleSubmit},__jsx(Form.l.Input,{type:"email",name:"email",required:!0,autoFocus:!0,placeholder:"Email",disabled:!editable,value:values.email,error:touched.email&&errors.email,onChange:handleChange,onKeyDown:function onKeyDown(e){e.key.toLocaleLowerCase()===keyValue.T.enter&&e.stopPropagation()}})),SubmitButton=__jsx(Dialog.V.TextButton,{type:"submit",form:"edit-email-form",disabled:isSubmitting||""===values.email||presetEmail===values.email,text:__jsx(message.Z,{defaultMessage:"Confirm",id:"N2IrpM"}),loading:isSubmitting});return __jsx(react.Fragment,null,__jsx(Dialog.V.Header,{title:__jsx(message.Z,{defaultMessage:"Email address",id:"FEI5Fv",description:"src/components/Dialogs/SetEmailDialog/Content.tsx"}),closeDialog,rightBtn:editable?SubmitButton:void 0}),__jsx(Dialog.V.Content,null,editable&&hasPassword&&__jsx(Dialog.V.Content.Message,{spacingBottom:!0},__jsx("p",null,__jsx(message.Z,{defaultMessage:"For security, we will {resetHint} for this. You can set your password again after verifying new email address.",id:"h9A6AT",description:"src/components/Dialogs/SetEmailDialog/Content.tsx",values:{resetHint:__jsx("span",{className:"u-highlight"},__jsx(message.Z,{defaultMessage:"reset your login password",id:"vsD2wm",description:"src/components/Dialogs/SetEmailDialog/Content.tsx"}))}}))),!editable&&__jsx(Dialog.V.Content.Message,{spacingBottom:!0},__jsx("p",null,__jsx(message.Z,{defaultMessage:"Email can be modified up to {count} times per day.",id:"0e1xjL",description:"src/components/Dialogs/SetEmailDialog/Content.tsx",values:{count:enums.MFd}}))),InnerForm),editable&&__jsx(Dialog.V.Footer,{smUpBtns:__jsx(react.Fragment,null,__jsx(Dialog.V.TextButton,{text:__jsx(message.Z,{defaultMessage:"Cancel",id:"47FYwb"}),color:"greyDarker",onClick:closeDialog}),SubmitButton)}),!editable&&__jsx(Dialog.V.Footer,{smUpBtns:__jsx(react.Fragment,null,__jsx(Dialog.V.TextButton,{text:__jsx(message.Z,{defaultMessage:"Close",id:"rbrahO"}),color:"greyDarker",onClick:closeDialog}))}))};try{Confirm.displayName="Confirm",Confirm.__docgenInfo={description:"",displayName:"Confirm",props:{closeDialog:{defaultValue:null,description:"",name:"closeDialog",required:!0,type:{name:"() => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/Dialogs/SetEmailDialog/Confirm.tsx#Confirm"]={docgenInfo:Confirm.__docgenInfo,name:"Confirm",path:"src/components/Dialogs/SetEmailDialog/Confirm.tsx#Confirm"})}catch(__react_docgen_typescript_loader_error){}},"./src/components/GQL/mutations/sendCode.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>__WEBPACK_DEFAULT_EXPORT__});var _templateObject,_home_runner_work_matters_web_matters_web_node_modules_babel_runtime_helpers_esm_taggedTemplateLiteral_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/taggedTemplateLiteral.js");const __WEBPACK_DEFAULT_EXPORT__=(0,__webpack_require__("./node_modules/graphql-tag/lib/index.js").ZP)(_templateObject||(_templateObject=(0,_home_runner_work_matters_web_matters_web_node_modules_babel_runtime_helpers_esm_taggedTemplateLiteral_js__WEBPACK_IMPORTED_MODULE_1__.Z)(["\n  mutation SendVerificationCode($input: SendVerificationCodeInput!) {\n    sendVerificationCode(input: $input)\n  }\n"])))}}]);